
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>实时聊天应用</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    #chat { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
    .message { margin-bottom: 10px; }
    .message.you { text-align: right; }
    .username { font-weight: bold; }
    .timestamp { font-size: 0.8em; color: #888; }
  </style>
</head>
<body>

<div id="profile-setup">
  <input type="text" id="username" placeholder="请输入用户名">
  <input type="file" id="avatar" accept="image/*">
  <button id="join-btn">加入聊天</button>
</div>

<div id="chat" style="display:none;"></div>
<input id="msg" placeholder="输入消息..." style="display:none;">
<button id="send" style="display:none;">发送</button>

<script>
const socket = io();
let userProfile = {};

document.getElementById('join-btn').onclick = function() {
  const username = document.getElementById('username').value.trim();
  const avatarFile = document.getElementById('avatar').files[0];

  if (!username || !avatarFile) {
    alert('请完整填写用户名并上传头像');
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    userProfile = { username, avatar: e.target.result };
    socket.emit('join', userProfile);

    document.getElementById('profile-setup').style.display = 'none';
    document.getElementById('chat').style.display = 'block';
    document.getElementById('msg').style.display = 'inline';
    document.getElementById('send').style.display = 'inline';
  };
  reader.readAsDataURL(avatarFile);
};

socket.on('message', (data) => {
  const chat = document.getElementById('chat');
  const isMe = data.username === userProfile.username;
  const message = document.createElement('div');
  message.className = 'message' + (isMe ? ' you' : '');
  message.innerHTML = `
    <div class="username">${data.username}</div>
    <div><img src="${data.avatar}" width="30" height="30" style="border-radius:50%;vertical-align:middle;"> ${data.msg}</div>
    <div class="timestamp">${new Date(data.time).toLocaleTimeString()}</div>
  `;
  chat.appendChild(message);
  chat.scrollTop = chat.scrollHeight;
});

socket.on('chat history', (messages) => {
  messages.forEach(data => socket.emit('message', data));
});

document.getElementById('send').onclick = function() {
  const msg = document.getElementById('msg').value.trim();
  if (!msg) return;
  socket.emit('chat message', { ...userProfile, msg, time: Date.now() });
  document.getElementById('msg').value = '';
};

socket.emit('get history');
</script>

</body>
</html>
