
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MemeMarket User List</title>
  <script src="https://s3.tradingview.com/tv.js"></script>
  <style>
    :root {
      --bg: #0d0d0d;
      --text: #ffffff;
      --panel: #1c1c1e;
      --bubble: #2c2c2e;
      --bubble-me: #0a84ff;
      --input-bg: #2c2c2e;
      --border: #333;
    }

    [data-theme="light"] {
      --bg: #ffffff;
      --text: #000000;
      --panel: #f5f5f5;
      --bubble: #e0e0e0;
      --bubble-me: #007aff;
      --input-bg: #ffffff;
      --border: #cccccc;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
    }

    header {
      height: 56px;
      background: var(--panel);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      position: relative;
      border-bottom: 1px solid var(--border);
    }

    .symbol-select select,
    .center-search input,
    #roomSearch {
      background: var(--input-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
    }

    .symbol-select {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .center-search {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }

    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    #chart {
      flex: 2;
      position: relative;
    }

    #tv-container {
      height: 100%;
    }

    .resizer {
      width: 5px;
      background: var(--border);
      cursor: col-resize;
    }

    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--panel);
      position: relative;
    }

    #chat-top {
      display: flex;
      justify-content: flex-end;
      padding: 6px 12px;
    }

    #chat-top button {
      font-size: 20px;
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
    }

    #messages {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bubble {
      background: var(--bubble);
      padding: 10px 14px;
      border-radius: 16px;
      max-width: 75%;
      color: var(--text);
    }

    .bubble.you {
      align-self: flex-end;
      background: var(--bubble-me);
      color: #fff;
    }

    #form {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid var(--border);
      position: relative;
    }

    #input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 14px;
      border: none;
      background: var(--input-bg);
      color: var(--text);
    }

    #send, #emoji-btn {
      padding: 10px 14px;
      background: var(--bubble-me);
      color: #fff;
      border: none;
      border-radius: 14px;
      cursor: pointer;
    }

    #emoji-popup {
      position: absolute;
      bottom: 55px;
      right: 90px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      display: none;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 24px;
    }

    .emoji {
      cursor: pointer;
      padding: 5px;
    }

    #user-popup {
      position: absolute;
      top: 40px;
      right: 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      display: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      z-index: 10;
    }
  </style>

<style>
.message-row {
  display: flex;
  align-items: flex-start;
  gap: 6px;
  margin-bottom: 10px;
}
.message-row.self {
  justify-content: flex-end;
  flex-direction: row-reverse;
}
.message-content {
  max-width: 70%;
  display: flex;
  flex-direction: column;
}
.message-content .name {
  font-size: 12px;
  color: var(--text);
  margin-bottom: 2px;
}
.message-content .bubble {
  background: var(--bubble);
  padding: 10px 14px;
  border-radius: 18px;
  color: var(--text);
  word-break: break-word;
}
.message-row.self .bubble {
  background: var(--bubble-me);
  color: white;
}
.message-content .time {
  font-size: 10px;
  color: #888;
  margin-top: 3px;
  align-self: flex-end;
}
.avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
}
</style>

</head>
<body>

<!-- 用户信息采集弹窗 -->
<div id="user-modal" class="modal">
  <div class="modal-content">
    <h2>欢迎来到 MemeChat</h2>
    <p>请设置你的头像和昵称</p>
    <input type="text" id="username-input" placeholder="输入昵称" />
    <input type="file" id="avatar-input" accept="image/*" />
    <button id="enter-chat">进入聊天室</button>
  </div>
</div>
<style>
  .modal {
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(8px);
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background: var(--panel);
    color: var(--text);
    padding: 30px;
    border-radius: 20px;
    text-align: center;
    width: 300px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
  }
  .modal-content input {
    margin-top: 12px;
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--input-bg);
    color: var(--text);
  }
  .modal-content button {
    margin-top: 20px;
    padding: 10px 20px;
    border-radius: 10px;
    background: var(--bubble-me);
    color: white;
    border: none;
    cursor: pointer;
  }
</style>

  <header>
    <div class="symbol-select">
      <label style="font-size:14px;">币种</label>
      <select id="symbolSelect">
        <option value="BTCUSDT">BTC</option>
        <option value="ETHUSDT">ETH</option>
        <option value="DOGEUSDT">DOGE</option>
        <option value="PEPEUSDT">PEPE</option>
      </select>
    </div>
    <div class="center-search">
      <input id="roomSearch" placeholder="🔍 搜索币种" />
    </div>
    <button onclick="toggleTheme()">🌓</button>
  </header>

  <div class="main">
    <div id="chart">
      <div class="resizer" id="resizer"></div>
      <div id="tv-container"></div>
    </div>
    <div id="chat">
      <div id="chat-top">
        <button onclick="toggleUsers()">👥</button>
      </div>
      <div id="user-popup">
        <div>🧑 CZ.eth</div>
        <div>🐸 PepeKing</div>
        <div>🚀 RocketDegen</div>
      </div>
      <div id="messages"></div>
      <form id="form">
        <input id="input" autocomplete="off" placeholder="说点什么..." />
        <button id="emoji-btn" type="button" onclick="toggleEmoji()">😊</button>
        <button id="send">发送</button>
        <div id="emoji-popup">
          <div class="emoji">😂</div>
          <div class="emoji">🤔</div>
          <div class="emoji">🚀</div>
          <div class="emoji">💩</div>
          <div class="emoji">🐸</div>
          <div class="emoji">❤️</div>
          <div class="emoji">👀</div>
          <div class="emoji">🥳</div>
          <div class="emoji">🔥</div>
          <div class="emoji">🙏</div>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentSymbol = "BTCUSDT";

    function loadChart(symbol, theme = "dark") {
      document.getElementById("tv-container").innerHTML = "";
      new TradingView.widget({
        container_id: "tv-container",
        autosize: true,
        symbol: "BINANCE:" + symbol,
        interval: "30",
        theme: theme,
        style: "1",
        locale: "en",
        enable_publishing: false
      });
    }

    
function appendMessage(msg, fromSelf = true, user = { name: username, avatar: avatarData }) {
  const wrapper = document.createElement("div");
  wrapper.className = "message-row " + (fromSelf ? "self" : "other");

  const avatar = document.createElement("img");
  avatar.className = "avatar";
  avatar.src = user.avatar;

  const content = document.createElement("div");
  content.className = "message-content";

  const name = document.createElement("div");
  name.className = "name";
  name.textContent = user.name;

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = msg;

  const time = document.createElement("div");
  time.className = "time";
  const now = new Date();
  time.textContent = now.getHours().toString().padStart(2, "0") + ":" + now.getMinutes().toString().padStart(2, "0");

  content.appendChild(name);
  content.appendChild(bubble);
  content.appendChild(time);

  if (fromSelf) {
    wrapper.appendChild(content);
    wrapper.appendChild(avatar);
  } else {
    wrapper.appendChild(avatar);
    wrapper.appendChild(content);
  }

  document.getElementById("messages").appendChild(wrapper);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}

      const div = document.createElement("div");
      div.className = "bubble you";
      div.textContent = msg;
      document.getElementById("messages").appendChild(div);
      document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    }

    document.getElementById("form").addEventListener("submit", function(e) {
      e.preventDefault();
      const val = document.getElementById("input").value.trim();
      if (!val) return;
      appendMessage(val);
      document.getElementById("input").value = "";
    });

    function toggleEmoji() {
      const popup = document.getElementById("emoji-popup");
      popup.style.display = popup.style.display === "flex" ? "none" : "flex";
    }

    function toggleUsers() {
      const userBox = document.getElementById("user-popup");
      userBox.style.display = userBox.style.display === "block" ? "none" : "block";
    }

    document.querySelectorAll(".emoji").forEach(emoji => {
      emoji.addEventListener("click", () => {
        appendMessage(emoji.textContent);
        document.getElementById("emoji-popup").style.display = "none";
      });
    });

    document.getElementById("symbolSelect").addEventListener("change", function() {
      currentSymbol = this.value;
      loadChart(currentSymbol, document.documentElement.getAttribute("data-theme"));
    });

    document.getElementById("roomSearch").addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        let val = this.value.trim().toUpperCase();
        if (!val.endsWith("USDT")) val += "USDT";
        currentSymbol = val;
        loadChart(currentSymbol, document.documentElement.getAttribute("data-theme"));
        document.getElementById("messages").innerHTML = "";
      }
    });

    function toggleTheme() {
      const root = document.documentElement;
      const isDark = root.getAttribute("data-theme") === "dark";
      root.setAttribute("data-theme", isDark ? "light" : "dark");
      loadChart(currentSymbol, isDark ? "light" : "dark");
    }

    const resizer = document.getElementById("resizer");
    const chart = document.getElementById("chart");
    const chat = document.getElementById("chat");
    let isDragging = false;

    resizer.addEventListener("mousedown", () => {
      isDragging = true;
      document.body.style.cursor = "col-resize";
    });

    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;
      const percent = e.clientX / window.innerWidth;
      chart.style.flex = percent;
      chat.style.flex = 1 - percent;
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
      document.body.style.cursor = "default";
    });

    loadChart(currentSymbol);

// ========== 用户信息收集 ==========
let username = localStorage.getItem("username");
let avatarData = localStorage.getItem("avatar");

function showUserModal() {
  document.getElementById("user-modal").style.display = "flex";
}

function hideUserModal() {
  document.getElementById("user-modal").style.display = "none";
}

if (!username || !avatarData) {
  showUserModal();
}

document.getElementById("enter-chat").onclick = function() {
  const name = document.getElementById("username-input").value.trim();
  const file = document.getElementById("avatar-input").files[0];
  if (!name || !file) {
    alert("请填写昵称并上传头像！");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(event) {
    avatarData = event.target.result;
    localStorage.setItem("username", name);
    localStorage.setItem("avatar", avatarData);
    username = name;
    hideUserModal();
  };
  reader.readAsDataURL(file);
};

// ========== 修改 appendMessage 逻辑 ==========

function appendMessage(msg, fromSelf = true, user = { name: username, avatar: avatarData }) {
  const wrapper = document.createElement("div");
  wrapper.className = "message-row " + (fromSelf ? "self" : "other");

  const avatar = document.createElement("img");
  avatar.className = "avatar";
  avatar.src = user.avatar;

  const content = document.createElement("div");
  content.className = "message-content";

  const name = document.createElement("div");
  name.className = "name";
  name.textContent = user.name;

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = msg;

  const time = document.createElement("div");
  time.className = "time";
  const now = new Date();
  time.textContent = now.getHours().toString().padStart(2, "0") + ":" + now.getMinutes().toString().padStart(2, "0");

  content.appendChild(name);
  content.appendChild(bubble);
  content.appendChild(time);

  if (fromSelf) {
    wrapper.appendChild(content);
    wrapper.appendChild(avatar);
  } else {
    wrapper.appendChild(avatar);
    wrapper.appendChild(content);
  }

  document.getElementById("messages").appendChild(wrapper);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}

  const container = document.createElement("div");
  container.style.display = "flex";
  container.style.flexDirection = "column";
  container.style.gap = "2px";

  const head = document.createElement("div");
  head.style.display = "flex";
  head.style.alignItems = "center";
  head.style.gap = "8px";

  const avatarImg = document.createElement("img");
  avatarImg.src = avatarData;
  avatarImg.style.width = "24px";
  avatarImg.style.height = "24px";
  avatarImg.style.borderRadius = "50%";

  const nameSpan = document.createElement("span");
  nameSpan.textContent = username;
  nameSpan.style.fontSize = "12px";

  head.appendChild(avatarImg);
  head.appendChild(nameSpan);

  const bubble = document.createElement("div");
  bubble.className = "bubble you";
  bubble.textContent = msg;

  const time = document.createElement("div");
  const now = new Date();
  time.textContent = now.getHours().toString().padStart(2, "0") + ":" + now.getMinutes().toString().padStart(2, "0");
  time.style.fontSize = "10px";
  time.style.color = "#888";
  time.style.alignSelf = "flex-end";

  container.appendChild(head);
  container.appendChild(bubble);
  container.appendChild(time);

  document.getElementById("messages").appendChild(container);
  document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}

  </script>
</body>
</html>
